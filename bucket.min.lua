redis.replicate_commands()local a,b=KEYS[1],tonumber(ARGV[1])local c=redis.call('time')local d=tonumber(c[1])+tonumber(c[2])/1e6;local e,f,g,h=pcall(cmsgpack.unpack,redis.pcall('get',a))if not e then f,g,h=d,0,{}end;local i=d-f;local j,k,l,m={},0,math.huge;for n=1,#ARGV/2 do local o,p=tonumber(ARGV[2*n]),tonumber(ARGV[2*n+1])h[n]=math.max(0,(h[n]or 0)-i*o)j[n]=h[n]+b;if p-j[n]<l then l,m=p-j[n],n end;k=math.max(k,math.ceil(math.max(p,j[n])/o))end;if l>=0 then redis.call('setex',a,k,cmsgpack.pack(d,0,j))return{1,tostring(l),m}else g=g+b;redis.call('setex',a,k,cmsgpack.pack(d,g,h))return{0,tostring(g),m}end